--[[
@copyright: fantasysky 2016
@website: https://www.fsky.pro
@brief: log outputf functions
@author: fanky
@version: 1.0
@date: 2021-04-24
--]]

----------------------------------------------------------------------
-- private
----------------------------------------------------------------------
local prefixes = {
	debug = "[DEBUG]|",
	error = "[ERROR]|",
	info  = "[INFO] |",
	trace = "[TRACE]|"
}

local function output(layer, prefix, msg, ...)
	local info = debug.getinfo(layer+1)
	local segs = {
		prefixes[prefix],
		os.date("%Y-%m-%d %H:%M:%S"),
		" ",
		string.sub(info.source, 2, -1),
		":",
		info.currentline,
		": ",
		tostring(msg)
	}
	for i=1, select('#', ...) do
		table.insert(segs, " " .. tostring(select(i, ...)))
	end
	return table.concat(segs)
end

local function outputf(layer, prefix, msg, ...)
	local info = debug.getinfo(layer+1)
	local segs = {
		prefixes[prefix],
		os.date("%Y-%m-%d %H:%M:%S"),
		" ",
		string.sub(info.source, 2, -1),
		":",
		info.currentline,
		": ",
		string.format(msg, ...)
	}
	return table.concat(segs)
end

function outtrace(layer)
	layer = layer + 1
	local indents = "  "
	local segs = {"\n", indents, "traceback:"}
	while(true)
	do
		layer = layer + 1
		local info = debug.getinfo(layer)
		if info == nil then break end
		indents = indents .. "  "
	
		table.insert(segs, "\n")
		table.insert(segs, indents)
		table.insert(segs, string.sub(info.source, 2, -1))
		table.insert(segs, ":" .. info.currentline)
		local fname = info.name
		if fname ~= nil then
			table.insert(segs, ": in function '" .. fname .. "'")
		end
	end
	return table.concat(segs)
end

----------------------------------------------------------------------
-- public
----------------------------------------------------------------------
local log = {}

-- 所有支持的频道名称
function log.channels() 
	local channels = {}
	for k, v in pairs(prefixes) do
		table.insert(channels, k)
	end
	return cahnnels
end

------------------------------------------------------------
-- 以空格分隔参数，直白返回 log 消息
------------------------------------------------------------
function log.debug(layer, msg, ...)
	return output(layer+1, "debug", msg, ...)
end

function log.error(layer, msg, ...)
	return output(layer+1, "error", msg, ...)
end

function log.info(layer, msg, ...)
	return output(layer+1, "info", msg, ...)
end

function log.trace(layer, msg, ...)
	layer = layer + 1
	local msg = output(layer+1, "trace", msg, ...)
	return msg .. outtrace(layer)
end

------------------------------------------------------------
-- 格式化返回 log 消息
------------------------------------------------------------
function log.debugf(layer, msg, ...)
	return outputf(layer+1, "debug", msg, ...)
end

function log.errorf(layer, msg, ...)
	return outputf(layer+1, "error", msg, ...)
end

function log.infof(layer, msg, ...)
	return outputf(layer+1, "info", msg, ...)
end

function log.tracef(layer, msg, ...)
	layer = layer + 1
	local msg = outputf(layer+1, "trace", msg, ...)
	return msg .. outtrace(layer)
end

return log
